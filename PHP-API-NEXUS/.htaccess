RewriteEngine On

# Configuración PHP para APIs JSON limpias
php_flag display_errors Off
php_flag log_errors On
php_value error_log /tmp/php_api_errors.log

# Configuración de charset
AddDefaultCharset UTF-8

# HABILITAR headers CORS desde Apache
<IfModule mod_headers.c>
    # Permitir orígenes específicos dinámicamente
    SetEnvIfNoCase Origin "^https?://(localhost:4200|127\.0\.0\.1:4200|.*\.ngrok-free\.app)$" ORIGIN_ALLOWED=$0
    
    # Establecer headers CORS solo para orígenes permitidos
    Header always set "Access-Control-Allow-Origin" "%{ORIGIN_ALLOWED}e" env=ORIGIN_ALLOWED
    Header always set "Access-Control-Allow-Credentials" "true"
    Header always set "Access-Control-Allow-Methods" "GET, POST, PUT, DELETE, OPTIONS"
    Header always set "Access-Control-Allow-Headers" "Content-Type, Authorization, X-Requested-With, Accept, Origin, ngrok-skip-browser-warning"
    Header always set "Access-Control-Max-Age" "86400"
    Header always set "ngrok-skip-browser-warning" "true"
</IfModule>

# Routing principal - redirigir todas las rutas al index.php (SIN headers CORS aquí)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [L,QSA]

# Evitar que se muestren archivos .env y de configuración
<Files ".env*">
    Order allow,deny
    Deny from all
</Files>

<Files "*.php">
    <IfModule mod_php.c>
        php_flag display_errors Off
        php_flag log_errors On
    </IfModule>
</Files>
